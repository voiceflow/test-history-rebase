version: 2.1

# This exposes the parameters to be overridden in the generated pipeline
parameters:
  ssh-fingerprint:
    type: string
    default: '93:f8:51:53:5e:bd:75:0e:29:24:4d:6a:3f:ef:e1:4a'

# this allows you to use CircleCI's dynamic configuration feature
setup: true

orbs:
  vfcommon: voiceflow/common@0.41.4
  gomplate: xavientois/gomplate@0.2.0

workflows:
  generate-config:
    when:
      not:
        equal: [scheduled_pipeline, << pipeline.trigger_source >>]
    jobs:
      - gomplate/render-config:
          context: dev-test
          executor: vfcommon/node-executor
          pre-steps:
            - checkout
            - vfcommon/set-env-name: # On bors branches, we will be running the e2e tests in a dev environment
                target_env_var: &env_name ENV_NAME
            - vfcommon/set-json-string-from-env:
                field: e2e_env_name
                value-env-var: *env_name
            - vfcommon/get_changed_files
            - vfcommon/set-service-data-json:
                service-directories: apps
            # TODO: Remove this once realtime-api is separated from realtime
            # This extra step is necessary to add realtime-api to the list of services to build
            # if the realtime source code has changed. The reason this is necessary is because
            # the step bases the list of services on the packages in the apps directory, and
            # realtime-api is not a package in the apps directory, it is just a copy of realtime.
            - run:
                name: Add realtime-api to the list of services to build if it has changed
                environment:
                  DIRECTORY: apps
                  SERVICE: realtime
                  COMPONENT_NAME: realtime-api
                  DOCKERFILE: Dockerfile
                command: |
                  echo "Checking if $SERVICE was modified..."
                  MODIFIED=false
                  if grep "$DIRECTORY/$SERVICE" \<<< "${CHANGED_FILES?}"; then
                    MODIFIED=true
                  fi

                  echo "Adding $SERVICE to values.json"
                  jq --argjson modified "$MODIFIED" --arg dockerfile "$DOCKERFILE" --arg name "$SERVICE" --arg component_name "$COMPONENT_NAME" --arg directory "$DIRECTORY" '.services += [{name: $name, modified: $modified, component_name: $component_name, directory: $directory, dockerfile: $dockerfile}]' values.json > values.json.tmp
                  mv values.json.tmp values.json
            - vfcommon/set-if-file-changed:
                file-patterns: package.json yarn.lock libs/.* types/.* meta/.*
                target-env-var: &build_all build_all_services
            - vfcommon/set-json-boolean-from-env:
                field: *build_all
                value-env-var: *build_all
            - vfcommon/set-json-string:
                field: branch
                # HACK: this cannot be empty, so we pass both branch and tag (only one of them will be non-empty)
                # TODO: Fix this once https://discuss.circleci.com/t/empty-string-for-parameter-breaks-config/47695 has a solution
                value: '<< pipeline.git.branch >><< pipeline.git.tag >>'
            - vfcommon/set-json-string:
                field: ecr_url
                value: 168387678261.dkr.ecr.us-east-1.amazonaws.com
            - vfcommon/set-json-string-from-env:
                field: common_orb_version
                value-env-var: COMMON_ORB_VERSION
            - run: cat values.json
          contexts: values.json
          filters:
            branches:
              ignore:
                - /.*\.tmp/

  # Cron Production update
  update-production-branch:
    when:
      and:
        - equal: [scheduled_pipeline, << pipeline.trigger_source >>]
        - equal: ['update-production-branch', << pipeline.schedule.name >>]
    jobs:
      - vfcommon/sync_branches:
          checkout: true
          ssh_key: << pipeline.parameters.ssh-fingerprint >>
          name: sync-branches-scheduled
          context: dev-test
          filters:
            branches:
              only: master
